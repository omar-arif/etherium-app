<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sepolia Wallet</title>
    <style>
      :root{
        color-scheme: light dark;
        --bg: #020617;
        --bg-soft: radial-gradient(circle at top left, #0f172a 0, #020617 45%, #000 100%);
        --shell: rgba(15, 23, 42, 0.96);
        --panel: rgba(15, 23, 42, 0.98);
        --panel-soft: rgba(15, 23, 42, 0.9);
        --text:#e5e7eb; --muted:#9ca3af; --border:#1e293b;
        --blue:#4f46e5; --blue2:#6366f1;
        --success:#22c55e; --danger:#f97373;
        --rowHover: rgba(79,70,229,.18);
        --rowSelected: rgba(79,70,229,.28);
        --badgeBg: rgba(15,23,42,.9);
        --shadow-shell: 0 22px 60px rgba(15, 23, 42, 0.95);
        --code-bg: rgba(15,23,42,.9);
        --code-border: rgba(148,163,184,.6);
        --code-text: #e5e7eb;
        --th-bg: rgba(15,23,42,0.9);
      }
      body.light{
        --bg:#f3f4f6;
        --bg-soft: radial-gradient(circle at top left, #e5e7eb 0, #f9fafb 45%, #e5e7eb 100%);
        --shell:#ffffff;
        --panel:#ffffff;
        --panel-soft:#f9fafb;
        --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
        --rowHover: rgba(79,70,229,.08);
        --rowSelected: rgba(79,70,229,.16);
        --badgeBg: rgba(15,23,42,.04);
        --shadow-shell: 0 18px 40px rgba(148, 163, 184, 0.45);
        --code-bg: #f3f4ff;
        --code-border: rgba(148,163,184,.8);
        --code-text: #111827;
        --th-bg: #f9fafb;
      }

      *{ box-sizing:border-box; }

      body{
        margin:0;
        min-height:100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
        background:var(--bg-soft);
        color:var(--text);
        display:flex;
        align-items:stretch;
        justify-content:center;
        padding:24px 16px;
        transition: background 0.3s ease, color 0.2s ease;
      }

      .wrap{
        width:100%;
        max-width:1180px;
        margin:auto;
        background:linear-gradient(135deg, rgba(148,163,184,0.06), rgba(15,23,42,0.22)), var(--shell);
        border-radius:28px;
        padding:20px 20px 18px;
        border:1px solid rgba(148, 163, 184, 0.35);
        box-shadow:var(--shadow-shell);
        backdrop-filter: blur(26px) saturate(150%);
      }

      .topbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:14px;
        flex-wrap:wrap;
        padding-bottom:10px;
        border-bottom:1px solid rgba(148,163,184,0.25);
      }

      .title-row{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
      }

      .logo-pill{
        width:32px;
        height:32px;
        border-radius:14px;
        background:radial-gradient(circle at 20% 10%, #f97316, #eab308 40%, #4f46e5 86%);
        border:1px solid rgba(15,23,42,0.85);
        display:inline-flex;
        align-items:center;
        justify-content:center;
        box-shadow:0 0 0 1px rgba(248,250,252,0.16), 0 0 26px rgba(234,179,8,0.9);
      }

      .logo-dot{
        width:12px;
        height:12px;
        border-radius:999px;
        background:#020617;
      }

      .title{
        margin:0;
        font-size:1.05rem;
        letter-spacing:0.02em;
        font-weight:600;
      }

      .subtitle{
        font-size:0.8rem;
        color:var(--muted);
        margin-top:4px;
      }

      .actions{
        display:flex;
        align-items:center;
        gap:8px;
        flex-wrap:wrap;
      }

      .btn{
        position:relative;
        background:linear-gradient(135deg, var(--blue), var(--blue2));
        color:white;
        border:none;
        border-radius:999px;
        padding:8px 14px;
        cursor:pointer;
        font-weight:600;
        font-size:0.82rem;
        display:inline-flex;
        align-items:center;
        gap:6px;
        box-shadow:0 12px 30px rgba(79,70,229,0.6);
        transition:box-shadow 0.16s ease, transform 0.08s ease, background 0.18s ease, opacity 0.16s ease;
      }
      .btn.secondary{
        background:var(--panel-soft);
        color:var(--text);
        border:1px solid rgba(148, 163, 184, 0.5);
        box-shadow:none;
      }
      .btn:hover:not(:disabled){
        transform:translateY(-1px);
        box-shadow:0 16px 36px rgba(79,70,229,0.8);
      }
      .btn.secondary:hover:not(:disabled){
        box-shadow:0 10px 26px rgba(15,23,42,0.5);
      }
      .btn:disabled{
        opacity:.65;
        cursor:not-allowed;
        box-shadow:none;
      }

      .btn-icon{
        width:18px;
        height:18px;
        border-radius:999px;
        border:1px solid rgba(248,250,252,0.6);
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-size:0.72rem;
        background:rgba(15,23,42,0.7);
      }

      .pill{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:3px 9px;
        border-radius:999px;
        background:var(--badgeBg);
        border:1px solid rgba(148,163,184,.4);
        font-size:11px;
      }
      .pill.ok{
        color:var(--success);
        border-color:rgba(34,197,94,.6);
      }
      .pill.bad{
        color:var(--danger);
        border-color:rgba(248,113,113,.7);
      }

      .muted{ color:var(--muted); }

      code{
        background:var(--code-bg);
        padding:2px 6px;
        border-radius:6px;
        font-size:12px;
        border:1px solid var(--code-border);
        color:var(--code-text);
      }

      .grid{
        display:flex;
        gap:16px;
        margin-top:16px;
      }
      .left, .right{
        background:var(--panel);
        border:1px solid rgba(148,163,184,0.32);
        border-radius:18px;
        padding:14px 14px 12px;
      }
      .left{
        flex: 1.4;
        min-width: 520px;
      }
      .right{
        flex: 1;
        min-width: 320px;
        position:sticky;
        top:14px;
        height: fit-content;
        background:var(--panel-soft);
      }

      table{
        width:100%;
        border-collapse:collapse;
        margin-top:10px;
        font-size:13px;
      }
      th,td{
        border-bottom:1px solid var(--border);
        padding:8px 8px;
        vertical-align:top;
      }
      th{
        text-align:left;
        color:var(--muted);
        font-weight:600;
        font-size:11px;
        text-transform:uppercase;
        letter-spacing:0.09em;
        background:var(--th-bg);
        position:sticky;
        top:0;
        z-index:1;
      }
      tr.clickable{
        cursor:pointer;
        transition:background 0.12s ease, transform 0.06s ease;
      }
      tr.clickable:hover{
        background:var(--rowHover);
      }
      tr.selected{
        background:var(--rowSelected);
      }

      a{
        color:var(--blue2);
        text-decoration:none;
      }
      a:hover{
        text-decoration:underline;
      }

      .kv{
        display:grid;
        grid-template-columns: 140px 1fr;
        gap:8px 10px;
        margin-top:12px;
      }
      .k{
        color:var(--muted);
        font-size:12px;
        text-transform:uppercase;
        letter-spacing:0.08em;
      }
      .v{
        font-size:13px;
        overflow-wrap:anywhere;
      }

      @media (max-width: 980px){
        body{
          padding:16px 10px;
        }
        .wrap{
          padding:14px 14px 12px;
          border-radius:22px;
        }
        .grid{
          flex-direction:column;
        }
        .left{
          min-width: 0;
        }
        .right{
          position:static;
          min-width:0;
        }
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script>
      const { useEffect, useMemo, useState } = React;
      const h = React.createElement;

      function short(s){ return s ? (s.slice(0,6) + "â€¦" + s.slice(-4)) : "-"; }

      function pickProvider(){
        const eth = window.ethereum;
        if (!eth) return null;
        if (Array.isArray(eth.providers) && eth.providers.length) {
          return eth.providers.find(p => p && p.isMetaMask) || eth.providers[0];
        }
        return eth;
      }

      function formatEtherFromHexWei(hexWei){
        try{
          const wei = BigInt(hexWei);
          const s = wei.toString().padStart(19, "0");
          const intPart = s.slice(0, -18);
          let frac = s.slice(-18).replace(/0+$/, "").slice(0, 6);
          return frac ? (intPart + "." + frac) : intPart;
        } catch { return "-"; }
      }

      function App(){
        const [dark, setDark] = useState(false);
        const [account, setAccount] = useState(null);
        const [chainId, setChainId] = useState(null);
        const [balance, setBalance] = useState("-");
        const [txs, setTxs] = useState([]);
        const [selectedHash, setSelectedHash] = useState(null);
        const [msg, setMsg] = useState("");
        const [busy, setBusy] = useState(false);

        const selectedTx = useMemo(
          () => (txs || []).find(t => t.hash === selectedHash) || null,
          [txs, selectedHash]
        );

        useEffect(() => {
          const saved = localStorage.getItem("theme");
          const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          const nextDark = saved ? (saved === "dark") : prefersDark;
          setDark(nextDark);
        }, []);

        useEffect(() => {
          document.body.classList.toggle("light", !dark);
          localStorage.setItem("theme", dark ? "dark" : "light");
        }, [dark]);

        async function refresh(addr){
          const p = pickProvider();
          if (!p || !addr) return;

          const cid = await p.request({ method:"eth_chainId" });
          setChainId(cid);

          const balHex = await p.request({ method:"eth_getBalance", params:[addr, "latest"] });
          setBalance(formatEtherFromHexWei(balHex));

          const t = await fetch("/api/txs?address=" + addr).then(r => r.json());
          const list = t.txs || [];
          setTxs(list);
          if (!selectedHash && list[0]?.hash) setSelectedHash(list[0].hash);
        }

        async function connectOrDisconnect(){
          const p = pickProvider();

          // disconnect (local)
          if (account){
            setAccount(null); setChainId(null); setBalance("-"); setTxs([]); setSelectedHash(null); setMsg("");
            return;
          }

          if (!p) { setMsg("MetaMask not detected."); return; }
          if (busy) return;

          setBusy(true);
          setMsg("");

          try{
            const accounts = await p.request({ method:"eth_requestAccounts" }); // [web:1]
            const a = accounts && accounts[0] ? accounts[0] : null;
            if (!a) { setMsg("No account returned."); setBusy(false); return; }

            setAccount(a);
            await refresh(a);
          } catch(e){
            setMsg(e?.message || "Connection failed.");
          } finally {
            setBusy(false);
          }
        }

        useEffect(() => {
          const p = pickProvider();
          if (!p || !p.on) return;

          const onAccountsChanged = (accounts) => {
            const a = accounts && accounts[0] ? accounts[0] : null;
            if (!a) {
              setAccount(null); setChainId(null); setBalance("-"); setTxs([]); setSelectedHash(null);
              return;
            }
            setAccount(a);
            refresh(a);
          };

          const onChainChanged = (cid) => {
            setChainId(cid);
            if (account) refresh(account);
          };

          p.on("accountsChanged", onAccountsChanged);
          p.on("chainChanged", onChainChanged);
          return () => {
            p.removeListener && p.removeListener("accountsChanged", onAccountsChanged);
            p.removeListener && p.removeListener("chainChanged", onChainChanged);
          };
        }, [account, selectedHash]);

        function StatusPill({status}){
          const ok = status === "success";
          return h("span", { className: "pill " + (ok ? "ok" : "bad") }, status || "-");
        }

        function TxDetails({tx}){
          if (!tx) {
            return h("div", null,
              h("h2", { style:{margin:"0 0 8px 0"} }, "Transaction"),
              h("div", { className:"muted" }, "Click a transaction on the left to see details.")
            );
          }

          const isOk = tx.status === "success";
          const statusText = tx.status || ((tx.isError === "1" || tx.txreceipt_status === "0") ? "failed" : "success");

          const fields = [
            ["Status", null],
            ["Date", tx.dateIso ? new Date(tx.dateIso).toLocaleString() : "-"],
            ["Hash", tx.hash],
            ["From", tx.from],
            ["To", tx.to],
            ["Value (ETH)", tx.valueEth],
            ["Value (wei)", tx.valueWei || tx.value],
            ["Block", tx.blockNumber],
            ["Nonce", tx.nonce],
            ["Gas", tx.gas],
            ["Gas price", tx.gasPrice],
            ["Gas used", tx.gasUsed],
            ["Cumulative gas used", tx.cumulativeGasUsed],
            ["Confirmations", tx.confirmations],
            ["Contract address", tx.contractAddress],
            ["MethodId", tx.methodId],
            ["Function name", tx.functionName],
            ["Input", tx.input],
          ];

          return h("div", null,
            h("div", { style:{display:"flex", alignItems:"center", justifyContent:"space-between", gap:"10px"} },
              h("h2", { style:{margin:"0"} }, "Transaction"),
              h("a", { href: tx.explorerUrl, target:"_blank", rel:"noreferrer" }, "View on Etherscan â†’")
            ),
            h("div", { style:{marginTop:"8px"} }, h(StatusPill, { status: statusText })),
            h("div", { className:"kv" },
              ...fields.map(([k, v]) => {
                if (k === "Status") {
                  return [
                    h("div", { className:"k", key:k+"k" }, "Status"),
                    h("div", { className:"v", key:k+"v" },
                      h("span", { style:{color: isOk ? "var(--success)" : "var(--danger)", fontWeight:800} }, statusText)
                    ),
                  ];
                }
                return [
                  h("div", { className:"k", key:k+"k" }, k),
                  h("div", { className:"v", key:k+"v" }, v ? h("code", null, String(v)) : "-"),
                ];
              }).flat()
            )
          );
        }

        return h("div", { className:"wrap" },
          h("div", { className:"topbar" },
            h("div", null,
              h("div", { className:"title-row" },
                h("div", { className:"logo-pill" }, h("div", { className:"logo-dot" })),
                h("h1", { className:"title" }, "Sepolia wallet"),
                h("span", { className:"pill " + (account ? "ok" : "bad") },
                  account ? "Connected" : "Disconnected"
                )
              ),
              h("div", { className:"subtitle" },
                "Read-only Sepolia balance and history via MetaMask + backend."
              )
            ),
            h("div", { className:"actions" },
              h("button", {
                className:"btn secondary",
                onClick: () => setDark(d => !d)
              },
                h("span", { className:"btn-icon" }, dark ? "â˜€" : "ðŸŒ™"),
                dark ? "Light mode" : "Dark mode"
              ),
              h("button", {
                className:"btn",
                onClick: connectOrDisconnect,
                disabled: busy
              },
                h("span", { className:"btn-icon" }, account ? "âœ“" : "â¦¿"),
                busy ? "Working..." : (account ? "Disconnect" : "Connect")
              )
            )
          ),

          h("div", { className:"muted", style:{ marginTop:"8px" } }, msg),
          h("div", { style:{ marginTop:"10px" } },
            h("span", null, "Account: ", h("code", null, account || "-"), " "),
            h("span", null, "ChainId: ", h("code", null, chainId || "-"), " "),
            h("span", null, "Balance: ", h("code", null, balance), " ETH")
          ),

          h("div", { className:"grid" },
            h("div", { className:"left" },
              h("div", { style:{display:"flex", alignItems:"center", justifyContent:"space-between"} },
                h("h2", { style:{margin:"0"} }, "Last 10 transactions"),
                account ? h("button", { className:"btn", onClick: () => refresh(account) }, "Refresh") : null
              ),

              h("table", null,
                h("thead", null,
                  h("tr", null,
                    h("th", null, "Date"),
                    h("th", null, "Status"),
                    h("th", null, "From"),
                    h("th", null, "To"),
                    h("th", null, "Value"),
                    h("th", null, "Hash")
                  )
                ),
                h("tbody", null,
                  (txs || []).map(tx => {
                    const selected = tx.hash === selectedHash;
                    return h("tr", {
                        key: tx.hash,
                        className: "clickable" + (selected ? " selected" : ""),
                        onClick: () => setSelectedHash(tx.hash),
                        title: "Click for details"
                      },
                      h("td", null, tx.dateIso ? new Date(tx.dateIso).toLocaleString() : "-"),
                      h("td", null, h(StatusPill, { status: tx.status })),
                      h("td", null, h("code", { title: tx.from }, short(tx.from))),
                      h("td", null, h("code", { title: tx.to }, short(tx.to))),
                      h("td", null, tx.valueEth ?? "-"),
                      h("td", null,
                        h("a", { href: tx.explorerUrl, target:"_blank", rel:"noreferrer", title: tx.hash },
                          h("code", null, short(tx.hash))
                        )
                      )
                    );
                  })
                )
              )
            ),

            h("div", { className:"right" }, h(TxDetails, { tx: selectedTx }))
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(h(App));
    </script>
  </body>
</html>
